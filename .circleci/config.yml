version: 2.1

parameters:
  docker_push:
    type: boolean
    default: false
  parallel_tests:
    type: integer
    default: 4
  pg_version:
    type: string
    default: "16.3"
  elixir_image_tag:
    type: string
    default: "1.19.1-erlang-27.2.2-node"

commands:
  checkout_repo:
    description: Checkout repository into ~/project
    steps:
      - checkout:
          path: ~/project

  restore_mix_cache:
    parameters:
      cache_key:
        type: string
    steps:
      - restore_cache:
          keys:
            - << parameters.cache_key >>
            - v1-mix-deps-

  save_mix_cache:
    parameters:
      cache_key:
        type: string
    steps:
      - save_cache:
          key: << parameters.cache_key >>
          paths:
            - deps

  restore_build_cache:
    parameters:
      cache_key:
        type: string
    steps:
      - restore_cache:
          keys:
            - << parameters.cache_key >>
            - v1-build-

  save_build_cache:
    parameters:
      cache_key:
        type: string
    steps:
      - save_cache:
          key: << parameters.cache_key >>
          paths:
            - _build

  wait_for_postgres:
    steps:
      - run:
          name: Wait for Postgres
          command: |
            for i in $(seq 1 30); do
              if pg_isready --timeout=2 >/dev/null 2>&1; then
                echo "Postgres is ready"
                exit 0
              fi
              echo "Waiting for Postgres... ($i/30)"
              sleep 1
            done
            echo "Postgres never became ready" >&2
            exit 1

jobs:
  setup:
    docker:
      - image: cimg/elixir:<< pipeline.parameters.elixir_image_tag >>
    working_directory: ~/project/net_auto
    steps:
      - checkout_repo
      - run:
          name: Install local Hex/Rebar
          command: |
            mix local.hex --force
            mix local.rebar --force
      - persist_to_workspace:
          root: ~/project
          paths:
            - .

  deps:
    docker:
      - image: cimg/elixir:<< pipeline.parameters.elixir_image_tag >>
        environment:
          MIX_ENV: dev
      - image: cimg/postgres:<< pipeline.parameters.pg_version >>
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: net_auto_test
    working_directory: ~/project/net_auto
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Detect docs-only changes
          command: |
            if ../scripts/ci/detect_changed_paths.sh; then
              echo "Docs-only change detected; halting remaining steps."
              circleci-agent step halt
            fi
      - restore_mix_cache:
          cache_key: v1-mix-deps-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - restore_build_cache:
          cache_key: v1-build-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - run:
          name: Install deps
          command: |
            mix deps.get
            mix deps.compile
      - save_mix_cache:
          cache_key: v1-mix-deps-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - save_build_cache:
          cache_key: v1-build-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - persist_to_workspace:
          root: ~/project
          paths:
            - .

  lint:
    docker:
      - image: cimg/elixir:<< pipeline.parameters.elixir_image_tag >>
        environment:
          MIX_ENV: dev
    working_directory: ~/project/net_auto
    steps:
      - attach_workspace:
          at: ~/project
      - restore_build_cache:
          cache_key: v1-build-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - run:
          name: Compile + format + credo
          command: |
            mix compile --warnings-as-errors
            mix format --check-formatted
            mix credo --strict

  dialyzer:
    docker:
      - image: cimg/elixir:<< pipeline.parameters.elixir_image_tag >>
        environment:
          MIX_ENV: dev
    working_directory: ~/project/net_auto
    steps:
      - attach_workspace:
          at: ~/project
      - restore_mix_cache:
          cache_key: v1-mix-deps-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - restore_build_cache:
          cache_key: v1-build-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - restore_cache:
          keys:
            - v1-dialyzer-plts-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - run:
          name: Build PLTs if missing
          command: |
            mix dialyzer --plt
      - save_cache:
          key: v1-dialyzer-plts-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
          paths:
            - _build/plts
      - run:
          name: Run dialyzer
          command: |
            mix dialyzer --format short

  security:
    docker:
      - image: cimg/elixir:<< pipeline.parameters.elixir_image_tag >>
        environment:
          MIX_ENV: dev
    working_directory: ~/project/net_auto
    steps:
      - attach_workspace:
          at: ~/project
      - restore_mix_cache:
          cache_key: v1-mix-deps-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - run:
          name: Sobelow + mix audit
          command: |
            mix sobelow -i Config.HTTPS --exit
            mix deps.audit --format short

  test:
    parallelism: << pipeline.parameters.parallel_tests >>
    docker:
      - image: cimg/elixir:<< pipeline.parameters.elixir_image_tag >>
        environment:
          MIX_ENV: test
          PGUSER: postgres
          PGPASSWORD: postgres
          PGHOST: 127.0.0.1
          PGDATABASE: net_auto_test
      - image: cimg/postgres:<< pipeline.parameters.pg_version >>
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: net_auto_test
    working_directory: ~/project/net_auto
    steps:
      - attach_workspace:
          at: ~/project
      - restore_mix_cache:
          cache_key: v1-mix-deps-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - restore_build_cache:
          cache_key: v1-build-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - run:
          name: Install Postgres client tools
          command: |
            if ! command -v pg_isready >/dev/null 2>&1; then
              sudo apt-get update || apt-get update
              sudo apt-get install -y --no-install-recommends postgresql-client || apt-get install -y --no-install-recommends postgresql-client
              rm -rf /var/lib/apt/lists/*
            fi
      - wait_for_postgres
      - run:
          name: Prepare database
          command: |
            MIX_ENV=test mix ecto.create --quiet
            MIX_ENV=test mix ecto.migrate --quiet
      - run:
          name: Run split tests
          command: |
            mkdir -p test_results
            circleci tests glob "test/**/*_test.exs" | circleci tests split --split-by=timings > test_files.txt
            if [[ -s test_files.txt ]]; then
              xargs -a test_files.txt mix test --color --max-failures 1
            else
              mix test --color --max-failures 1
            fi
      - run:
          name: Coverage & gate (node 0)
          command: |
            if [[ "${CIRCLE_NODE_INDEX}" == "0" ]]; then
              mix coveralls.json
              ../scripts/ci/coverage_gate.sh 85 cover/excoveralls.json
            else
              echo "Skipping coverage on node ${CIRCLE_NODE_INDEX}";
            fi
      - run:
          name: Prepare artifact directories
          command: |
            mkdir -p cover tmp test_results
      - store_test_results:
          path: test_results
      - store_artifacts:
          path: test_results
      - store_artifacts:
          path: cover
      - store_artifacts:
          path: tmp

  build_release:
    docker:
      - image: cimg/elixir:<< pipeline.parameters.elixir_image_tag >>
        environment:
          MIX_ENV: prod
    working_directory: ~/project/net_auto
    steps:
      - attach_workspace:
          at: ~/project
      - restore_mix_cache:
          cache_key: v1-mix-deps-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - restore_build_cache:
          cache_key: v1-build-<< pipeline.parameters.elixir_image_tag >>-{{ checksum "mix.lock" }}
      - run:
          name: Compile warnings-as-errors
          command: |
            MIX_ENV=prod mix compile --warnings-as-errors
      - run:
          name: Assets deploy
          command: |
            MIX_ENV=prod mix assets.deploy
      - run:
          name: Build release
          command: |
            MIX_ENV=prod mix release
      - store_artifacts:
          path: _build/prod/rel

  docker_build_push:
    parameters:
      docker_push:
        type: boolean
        default: false
    docker:
      - image: cimg/base:stable
    working_directory: ~/project/net_auto
    steps:
      - run:
          name: Respect docker_push flag
          command: |
            if [ "<< parameters.docker_push >>" != "true" ]; then
              echo "docker_push=false; halting job."
              circleci-agent step halt
            fi
      - attach_workspace:
          at: ~/project
      - setup_remote_docker
      - run:
          name: Docker login (GHCR)
          command: |
            echo "$GHCR_PAT" | docker login ghcr.io -u "$CIRCLE_PROJECT_USERNAME" --password-stdin
      - run:
          name: Build & push image
          command: |
            IMAGE="ghcr.io/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${CIRCLE_SHA1}"
            docker build -f Dockerfile -t "$IMAGE" .
            docker push "$IMAGE"

  deploy_stub:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Deployment placeholder
          command: echo "Deploy stub - replace with real deployment."

workflows:
  ci:
    jobs:
      - setup
      - deps:
          requires:
            - setup
      - lint:
          requires:
            - deps
      - security:
          requires:
            - deps
      - dialyzer:
          requires:
            - deps
      - test:
          requires:
            - deps
      - build_release:
          requires:
            - lint
            - security
            - dialyzer
            - test
      - docker_build_push:
          docker_push: << pipeline.parameters.docker_push >>
          context: netauto-ci
          requires:
            - build_release

  nightly:
    triggers:
      - schedule:
          cron: "0 2 * * *"
          filters:
            branches:
              only: main
    jobs:
      - setup
      - deps:
          requires:
            - setup
      - security:
          requires:
            - deps
      - dialyzer:
          requires:
            - deps
      - test:
          requires:
            - deps
      - build_release:
          requires:
            - security
            - dialyzer
            - test

  release:
    jobs:
      - setup:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - deps:
          requires:
            - setup
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - lint:
          requires:
            - deps
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - security:
          requires:
            - deps
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - dialyzer:
          requires:
            - deps
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - test:
          requires:
            - deps
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - build_release:
          requires:
            - lint
            - security
            - dialyzer
            - test
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - docker_build_push:
          docker_push: true
          context: netauto-ci
          requires:
            - build_release
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - deploy_gate:
          type: approval
          requires:
            - docker_build_push
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - deploy_stub:
          requires:
            - deploy_gate
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/