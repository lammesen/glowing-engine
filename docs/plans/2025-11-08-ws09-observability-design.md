# WS09 Observability Design

## Intent
Instrument the platform with telemetry and dashboards so operators can see runner activity, LiveView responsiveness, and command throughput from a single PromEx/Grafana setup. The goal is to ship PromEx modules plus bundled dashboards inside the repo.

## Scope & Constraints
- PromEx already a dependency; weâ€™ll add a `NetAuto.PromEx` module with plugins for Ecto, Phoenix, Oban, plus custom metrics.
- Grafana dashboards generated by PromEx (`mix prom_ex.dashboard.create`) stored under `lib/net_auto/prom_ex/dashboards/` and auto-loaded.
- Metrics must include: runner lifecycle (start/stop/duration), LiveView latency/load, device/command throughput.
- Avoid shipping secrets: PromEx uses environment-driven Grafana creds.
- Ensure Telemetry events exist (or add them) for runner lifecycle; reuse Phoenix/Oban events for LiveView/Ecto.

## Metrics Breakdown
1. **Runner lifecycle (WS05 tie-in)**
   - Telemetry events: `[:net_auto, :runner, :start | :stop | :error]` carrying `run_id`, `device_id`, durations, bytes.
   - PromEx handles: `summary` for durations, `counter` for starts/stops/errors, `last_value` for bytes processed.
   - Tag by `device_site`, `protocol`, `status`.

2. **LiveView health**
   - Use `PromEx.Plugins.PhoenixLiveView` for render/connect durations, connected sessions.
   - Add custom `:net_auto, :liveview, :mount` event to log Device Run LV mount time + streaming errors.

3. **Device/command throughput**
   - Hook `Automation.create_run/1` and `Automation.append_chunk/1` with Telemetry events.
   - Counters for runs per site/protocol, chunk throughput per minute, bytes per run via `summary`.

## Dashboard Layouts
- `runner_overview.json`: cards for active runs, charts for duration histogram, error rate, bytes processed.
- `liveview_health.json`: time-series for render latency, connected sessions, event backlogs.
- `command_throughput.json`: runs/sec per site, top N devices by run volume, chunk bandwidth.

## Integration Plan
- Add `NetAuto.PromEx` module defining plugins and metrics; register in `NetAuto.Application`.
- Provide config in `config/config.exs` and `config/runtime.exs` for Grafana URL/API key.
- Add Telemetry events in runner pipeline / automation context (guard nil events for now if WS05 not ready).
- Generate dashboards via PromEx mix task; commit JSON.
- Document setup in README (how to run Grafana container or point to existing one).

## Testing Strategy
- Unit tests for custom PromEx plugins ensure metric definitions compile.
- Integration: run `mix prom_ex.metrics` to ensure module compiles.
- LiveView metrics validated via Telemetry test handlers (assert event firing on mount).
- Provide manual Grafana check instructions (import JSON, verify panels populate with sample data).
